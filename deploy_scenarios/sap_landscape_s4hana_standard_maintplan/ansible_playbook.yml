---
# Ansible Playbook for SAP S/4HANA Standard installation

# Use include_role / include_tasks inside Ansible Task block, instead of using roles declaration or Task block with import_roles.
# This ensures Ansible Roles, and the tasks within, will be parsed in sequence instead of parsing at Playbook initialization.


- name: Ansible Play to validate the variables
  hosts: localhost
  # gather_facts is required for loop over hostvars
  tasks:

    - name: Assert that the variable 'sap_vm_provision_iac_type' is valid
      ansible.builtin.assert:
        that:
          - sap_vm_provision_iac_type is defined
          - sap_vm_provision_iac_type in ['ansible', 'ansible_to_terraform', 'existing_hosts']
        fail_msg: |
          The variable 'sap_vm_provision_iac_type' is undefined or invalid.
          Available options: ansible, ansible_to_terraform, existing_hosts

    - name: Assert that the variable 'sap_vm_provision_iac_platform' is valid
      ansible.builtin.assert:
        that:
          - sap_vm_provision_iac_platform is defined
          - sap_vm_provision_iac_platform in
            ['aws_ec2_vs', 'gcp_ce_vm', 'msazure_vm', 'ibmcloud_powervs', 'ibmcloud_vs', 'ibmpowervm_vm', 'kubevirt_vm', 'ovirt_vm', 'vmware_vm', 'existing_hosts']
        fail_msg: |
          The variable 'sap_vm_provision_iac_platform' is undefined or invalid.
          Available options: aws_ec2_vs, gcp_ce_vm, msazure_vm, ibmcloud_powervs, ibmcloud_vs, ibmpowervm_vm, kubevirt_vm, ovirt_vm, vmware_vm, existing_hosts

    # Ignore registered vars and sap_swpm hostnames which could contain hostvars.
    - name: Prepare list of SAP variables for validation  # noqa: ignore-errors
      ansible.builtin.set_fact:
        sap_playbook_dictionary_vars:
          "{{ dict(sap_playbook_dictionary_vars | zip(lookup('ansible.builtin.vars', *sap_playbook_dictionary_vars))) }}"
      vars:
        sap_playbook_dictionary_vars:
          "{{ lookup('ansible.builtin.varnames', '^(__)?sap_', wantlist=true)
              | reject('search', '(^(__)?sap_swpm_.*_hostname$)|(.*_register$)')
              | reject('in', ['sap_swpm_db_host'])
              | list }}"
      no_log: true
      ignore_errors: true

    - name: Identify variables with placeholder values or empty passwords  # noqa: ignore-errors
      ansible.builtin.set_fact:
        sap_playbook_placeholder_vars:
          "{{ sap_playbook_dictionary_vars | dict2items
              | selectattr('value', 'equalto', 'ENTER_STRING_VALUE_HERE') | map(attribute='key') | list }}"

        sap_playbook_empty_password_vars:
          "{{ sap_playbook_dictionary_vars | dict2items | selectattr('key', 'search', 'password')
              | selectattr('value', 'in', [none, '']) | map(attribute='key') | list }}"
      no_log: true
      ignore_errors: true

    - name: Report SAP variable validation failures
      ansible.builtin.fail:
        msg: |
          Please address the following issues before re-running the playbook:
          {% if sap_playbook_placeholder_vars | length > 0 %}
          - Placeholder values found for variable(s):
            {% for item in sap_playbook_placeholder_vars %}
            {{ item }}
            {% endfor %}

          {% endif %}
          {% if sap_playbook_empty_password_vars | length > 0 %}
          - Empty or invalid values found for password variable(s):
            {% for item in sap_playbook_empty_password_vars %}
            {{ item }}
            {% endfor %}
          {% endif %}
      when:
        - sap_playbook_placeholder_vars | d([]) | length > 0 or sap_playbook_empty_password_vars | d([]) | length > 0


#### Begin Infrastructure-as-Code provisioning ####
- name: Ansible Play to create dynamic inventory group for provisioning
  hosts: localhost
  gather_facts: false
  tasks:

    - name: Block to prepare inventory for provisioning
      when:
        - sap_vm_provision_iac_type in ['ansible', 'ansible_to_terraform']
        - sap_vm_provision_iac_platform != 'existing_hosts'
      vars:
        __sap_playbook_host_dictionary_name: "{{ 'sap_vm_provision_' ~ sap_vm_provision_iac_platform ~ '_host_specifications_dictionary' }}"
      block:
        - name: Assert that the variable {{ __sap_playbook_host_dictionary_name }} is defined and valid
          ansible.builtin.assert:
            that:
              - lookup('ansible.builtin.vars', __sap_playbook_host_dictionary_name) is defined
              - lookup('ansible.builtin.vars', __sap_playbook_host_dictionary_name) is mapping
              - lookup('ansible.builtin.vars', __sap_playbook_host_dictionary_name) | length > 0
            fail_msg: |
              The variable {{ __sap_playbook_host_dictionary_name }} is undefined or invalid.
              It must be a non-empty dictionary.

        - name: Assert that the variable 'sap_vm_provision_host_specification_plan' is defined and valid
          ansible.builtin.assert:
            that:
              - sap_vm_provision_host_specification_plan is defined
              - sap_vm_provision_host_specification_plan is string
              - sap_vm_provision_host_specification_plan | trim | length > 0
            fail_msg: |
              The variable 'sap_vm_provision_host_specification_plan' is undefined or invalid.
              It must be a non-empty string.

        - name: Assert that the variable 'sap_vm_provision_host_specification_plan' is present in a dictionary
          ansible.builtin.assert:
            that:
              - lookup('ansible.builtin.vars', __sap_playbook_host_dictionary_name)[sap_vm_provision_host_specification_plan] is defined
              - lookup('ansible.builtin.vars', __sap_playbook_host_dictionary_name)[sap_vm_provision_host_specification_plan] is mapping
              - lookup('ansible.builtin.vars', __sap_playbook_host_dictionary_name)[sap_vm_provision_host_specification_plan] | length > 0
            fail_msg: |
              The variable 'sap_vm_provision_host_specification_plan' is not present in a dictionary {{ __sap_playbook_host_dictionary_name }}.

        - name: Create dynamic inventory group for Ansible Role sap_vm_provision
          ansible.builtin.add_host:
            name: "{{ item }}"
            group: sap_vm_provision_target_inventory_group
          loop: "{{ lookup('ansible.builtin.vars', __sap_playbook_host_dictionary_name)[sap_vm_provision_host_specification_plan].keys() }}"


# Ansible Play target hosts pattern, use Inventory Group created by previous Ansible Task (add_host)
- name: Ansible Play to provision hosts for SAP
  hosts: sap_vm_provision_target_inventory_group
  gather_facts: false
  tasks:

    - name: Execute Ansible Role sap_vm_provision
      ansible.builtin.include_role:
        name: community.sap_infrastructure.sap_vm_provision
      when:
        - sap_vm_provision_iac_type in ['ansible', 'ansible_to_terraform']
        - sap_vm_provision_iac_platform != 'existing_hosts'


#### VM storage filesystem setup ####
- name: Ansible Play for hosts storage setup
  hosts: all
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    # Use inventory_hostname_short to retrieve host specification from the dictionary.
    # While ansible_hostname will work for Ansible only, using Ansible>Terraform may see ansible_hostname as 'localhost' and fail
    - name: Execute Ansible Role sap_storage_setup
      ansible.builtin.include_role:
        name: community.sap_install.sap_storage_setup
      vars:
        sap_playbook_host_dictionary_hostname:
          "{{ lookup('ansible.builtin.vars', 'sap_vm_provision_' + sap_vm_provision_iac_platform
           + '_host_specifications_dictionary')[sap_vm_provision_host_specification_plan][inventory_hostname_short] }}"
        sap_storage_setup_sid: "{{ sap_playbook_host_dictionary_hostname.get('sap_storage_setup_sid', (sap_system_sid | d(''))) }}"
        sap_storage_setup_nwas_abap_ascs_instance_nr:
          "{{ sap_playbook_host_dictionary_hostname.get('sap_storage_setup_nwas_abap_ascs_instance_nr', (sap_system_nwas_abap_ascs_instance_nr | d(''))) }}"
        sap_storage_setup_nwas_abap_pas_instance_nr:
          "{{ sap_playbook_host_dictionary_hostname.get('sap_storage_setup_nwas_abap_pas_instance_nr', (sap_system_nwas_abap_pas_instance_nr | d(''))) }}"
        sap_storage_setup_nwas_abap_aas_instance_nr:
          "{{ sap_playbook_host_dictionary_hostname.get('sap_storage_setup_nwas_abap_aas_instance_nr', (sap_system_nwas_abap_aas_instance_nr | d(''))) }}"
        sap_storage_setup_host_type: "{{ sap_playbook_host_dictionary_hostname.get('sap_storage_setup_host_type', []) }}"
      when: sap_playbook_host_dictionary_hostname is defined


- name: Ansible Play for ensuring rsync on all hosts
  hosts: all
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    - name: Install rsync
      ansible.builtin.package:
        name: rsync
        state: present


#### Begin downloading SAP software installation media to hosts ####
- name: Ansible Play for downloading SAP S/4HANA installation media
  hosts: project_dev_nwas_pas
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    # SAP software download will only occur if the 'community.sap_launchpad' collection is installed.
    # Playbook will continue without the collection, assuming SAP software is already available.
    - name: Check availability of sap_launchpad collection on execution node
      delegate_to: localhost
      become: false  # Enables usage of Python VENV
      ansible.builtin.command:
        cmd: ansible-galaxy collection list
      register: sap_playbook_collection_list_output

    - name: Execute Ansible Role sap_software_download
      ansible.builtin.include_role:
        name: community.sap_launchpad.sap_software_download
      vars:
        sap_software_download_suser_id: "{{ sap_id_user }}"
        sap_software_download_suser_password: "{{ sap_id_user_password }}"
        sap_software_download_directory: "{{ sap_install_media_detect_source_directory }}"
        sap_software_download_deduplicate: first
        sap_software_download_files: "{{ sap_software_install_dictionary[sap_software_product]
          ['softwarecenter_search_list_' ~ ansible_architecture] }}"
        sap_software_download_mp_transaction: "{{ sap_maintenance_planner_transaction_name }}"
      when: sap_playbook_collection_list_output.stdout_lines | select('search', 'community.sap_launchpad') | length > 0

    - name: Find SAP HANA installation media
      ansible.builtin.find:
        paths:
          - "{{ sap_install_media_detect_source_directory }}"
        patterns: "{{ sap_software_install_dictionary[sap_software_product]['software_files_hana_wildcard_list'] }}"
        recurse: true
      register: sap_hana_install_media_files

    - name: Find SAP NetWeaver ASCS and PAS installation media
      ansible.builtin.find:
        paths:
          - "{{ sap_install_media_detect_source_directory }}"
        patterns: "{{ sap_software_install_dictionary[sap_software_product]['software_files_wildcard_list'] }}"
        recurse: true
      register: sap_nwas_install_media_files

    - name: Prepare for file transfers, copy Private SSH Key from local
      ansible.builtin.copy:
        src: "{{ sap_vm_provision_ssh_host_private_key_file_path
          if sap_vm_provision_ssh_host_private_key_file_path is defined
          else sap_vm_provision_terraform_work_dir_path ~ '/ssh/hosts_rsa' }}"
        dest: "/tmp/hosts_rsa"
        mode: "0400"


- name: Ansible Play for host variables
  hosts: project_dev_hana_primary, project_tst_hana_primary, project_prd_hana_primary, project_dev_nwas_pas, project_tst_nwas_pas, project_prd_nwas_pas
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    - name: Set fact for host names
      ansible.builtin.set_fact:
        sap_inventory_project_dev_hana_primary_hostname: "{{ hostvars[inventory_hostname].groups.project_dev_hana_primary[0] }}"
        sap_inventory_project_dev_nwas_pas_hostname: "{{ hostvars[inventory_hostname].groups.project_dev_nwas_pas[0] }}"
        sap_inventory_project_tst_hana_primary_hostname: "{{ hostvars[inventory_hostname].groups.project_tst_hana_primary[0] }}"
        sap_inventory_project_tst_nwas_pas_hostname: "{{ hostvars[inventory_hostname].groups.project_tst_nwas_pas[0] }}"
        sap_inventory_project_prd_hana_primary_hostname: "{{ hostvars[inventory_hostname].groups.project_prd_hana_primary[0] }}"
        sap_inventory_project_prd_nwas_pas_hostname: "{{ hostvars[inventory_hostname].groups.project_prd_nwas_pas[0] }}"

    - name: Set var of IP Addresses of hosts
      ansible.builtin.set_fact:
        sap_inventory_project_dev_hana_primary_ip: "{{ hostvars[sap_inventory_project_dev_hana_primary_hostname].ansible_host }}"
        sap_inventory_project_dev_nwas_pas_ip: "{{ hostvars[sap_inventory_project_dev_nwas_pas_hostname].ansible_host }}"
        sap_inventory_project_tst_hana_primary_ip: "{{ hostvars[sap_inventory_project_tst_hana_primary_hostname].ansible_host }}"
        sap_inventory_project_tst_nwas_pas_ip: "{{ hostvars[sap_inventory_project_tst_nwas_pas_hostname].ansible_host }}"
        sap_inventory_project_prd_hana_primary_ip: "{{ hostvars[sap_inventory_project_prd_hana_primary_hostname].ansible_host }}"
        sap_inventory_project_prd_nwas_pas_ip: "{{ hostvars[sap_inventory_project_prd_nwas_pas_hostname].ansible_host }}"


- name: Ansible Play for updating /etc/hosts file before SAP software installations
  hosts: project_dev_hana_primary, project_tst_hana_primary, project_prd_hana_primary, project_dev_nwas_pas, project_tst_nwas_pas, project_prd_nwas_pas
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    # Ensure SAP AnyDB, SAP HANA or SAP NetWeaver hostname is not localhost in /etc/hosts.
    # See SAP Note 1054467 - Local host name refers to loopback address
    - name: Update /etc/hosts file
      ansible.builtin.lineinfile:
        dest: /etc/hosts
        line: "{{ item }}"
        state: present
      loop:
        - "{{ sap_inventory_project_dev_hana_primary_ip }}\t{{ sap_inventory_project_dev_hana_primary_hostname }}.{{ ansible_domain }}\t{{ sap_inventory_project_dev_hana_primary_hostname }}"
        - "{{ sap_inventory_project_dev_nwas_pas_ip }}\t{{ sap_inventory_project_dev_nwas_pas_hostname }}.{{ ansible_domain }}\t{{ sap_inventory_project_dev_nwas_pas_hostname }}"
        - "{{ sap_inventory_project_tst_hana_primary_ip }}\t{{ sap_inventory_project_tst_hana_primary_hostname }}.{{ ansible_domain }}\t{{ sap_inventory_project_tst_hana_primary_hostname }}"
        - "{{ sap_inventory_project_tst_nwas_pas_ip }}\t{{ sap_inventory_project_tst_nwas_pas_hostname }}.{{ ansible_domain }}\t{{ sap_inventory_project_tst_nwas_pas_hostname }}"
        - "{{ sap_inventory_project_prd_hana_primary_ip }}\t{{ sap_inventory_project_prd_hana_primary_hostname }}.{{ ansible_domain }}\t{{ sap_inventory_project_prd_hana_primary_hostname }}"
        - "{{ sap_inventory_project_prd_nwas_pas_ip }}\t{{ sap_inventory_project_prd_nwas_pas_hostname }}.{{ ansible_domain }}\t{{ sap_inventory_project_prd_nwas_pas_hostname }}"


- name: Ansible Play for copying SAP HANA Database Server installation media to other hosts
  hosts: project_dev_hana_primary, project_tst_hana_primary, project_prd_hana_primary
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    - name: Transfer SAP HANA installation media to SAP HANA Primary
      delegate_to: "{{ sap_inventory_project_dev_nwas_pas_ip }}"
      remote_user: "root"
      ansible.posix.synchronize:
        src: "{{ item }}"
        dest: "{{ sap_install_media_detect_source_directory | trim | regex_replace('//', '/') | regex_replace(' ', '') | regex_replace('\\/+$', '') + '/' }}"
        mode: "push"
        dest_port: 22
        use_ssh_args: false
        verify_host: false
        private_key: "/tmp/hosts_rsa"
        # set_remote_user: false
      loop: "{{ hostvars[sap_inventory_project_dev_nwas_pas_hostname].sap_hana_install_media_files.files | map(attribute='path') | list }}"


- name: Ansible Play for copying SAP NetWeaver installation media to host
  hosts: project_tst_nwas_pas, project_prd_nwas_pas # removed project_dev_nwas_pas as this is a roundtrip
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    - name: Transfer SAP NetWeaver ASCS installation media to host
      delegate_to: "{{ sap_inventory_project_dev_nwas_pas_ip }}"
      remote_user: "root"
      ansible.posix.synchronize:
        src: "{{ item }}"
        dest: "{{ sap_install_media_detect_source_directory | trim | regex_replace('//', '/') | regex_replace(' ', '') | regex_replace('\\/+$', '') + '/' }}"
        mode: "push"
        dest_port: 22
        use_ssh_args: false
        verify_host: false
        private_key: "/tmp/hosts_rsa"
        # set_remote_user: false
      loop: "{{ hostvars[sap_inventory_project_dev_nwas_pas_hostname].sap_nwas_install_media_files.files | map(attribute='path') | list }}"


- name: Ansible Play to remove temporary files from SAP NetWeaver PAS
  hosts: project_dev_nwas_pas
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    - name: Remove temporary file, if it exists
      ansible.builtin.file:
        path: "/tmp/hosts_rsa"
        state: absent


#### Begin SAP software hosts preparation ####
- name: Ansible Play for preparing all SAP software hosts
  hosts: project_dev_hana_primary, project_tst_hana_primary, project_prd_hana_primary, project_dev_nwas_pas, project_tst_nwas_pas, project_prd_nwas_pas
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    - name: Execute Ansible Role sap_general_preconfigure
      ansible.builtin.include_role:
        name: community.sap_install.sap_general_preconfigure


- name: Ansible Play for preparing all SAP NetWeaver hosts
  hosts: project_dev_nwas_pas, project_tst_nwas_pas, project_prd_nwas_pas
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:
    - name: Execute Ansible Role sap_netweaver_preconfigure
      ansible.builtin.include_role:
        name: community.sap_install.sap_netweaver_preconfigure


- name: Ansible Play for preparing all SAP HANA hosts
  hosts: project_dev_hana_primary, project_tst_hana_primary, project_prd_hana_primary
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:
    - name: Execute Ansible Role sap_hana_preconfigure
      ansible.builtin.include_role:
        name: community.sap_install.sap_hana_preconfigure


#### Begin SAP software installations ####
- name: Ansible Play for SAP HANA Database Server installation
  hosts: project_dev_hana_primary, project_tst_hana_primary, project_prd_hana_primary
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    - name: Execute Ansible Role sap_install_media_detect
      ansible.builtin.include_role:
        name: community.sap_install.sap_install_media_detect
      vars:
        sap_install_media_detect_swpm: false
        sap_install_media_detect_hostagent: true
        sap_install_media_detect_igs: false
        sap_install_media_detect_kernel: false
        sap_install_media_detect_webdisp: false
        sap_install_media_detect_db: "saphana"

    - name: Execute Ansible Role sap_hana_install
      ansible.builtin.include_role:
        name: community.sap_install.sap_hana_install


- name: Ansible Play for SAP NetWeaver Application Server installation - ABAP Central Services (ASCS), Database Load, Primary Application Server (PAS)
  hosts: project_dev_nwas_pas, project_tst_nwas_pas, project_prd_nwas_pas
  become: true
  any_errors_fatal: true
  max_fail_percentage: 0
  tasks:

    - name: Execute Ansible Role sap_install_media_detect
      ansible.builtin.include_role:
        name: community.sap_install.sap_install_media_detect
      vars:
        sap_install_media_detect_swpm: true
        sap_install_media_detect_hostagent: true
        sap_install_media_detect_igs: true
        sap_install_media_detect_kernel: true
        sap_install_media_detect_webdisp: false
        sap_install_media_detect_db_client: "saphana"
        sap_install_media_detect_export: "saps4hana"

    - name: Execute Ansible Role sap_swpm
      ansible.builtin.include_role:
        name: community.sap_install.sap_swpm
      vars:
        sap_swpm_db_host: "{{ lookup('vars', 'sap_inventory_' + sap_system_type + '_hana_primary_hostname') }}"
        sap_swpm_templates_product_input: "{{ sap_software_product }}"
